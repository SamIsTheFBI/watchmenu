#!/usr/bin/env bash

# Check if script is already running
if [ "$(pgrep -f "${0}")" != "$$" ]; then
    SCRIPTNAME="$(echo "${0}" | awk -F '/' '{print $NF}')"
    echo "Another instance of ${SCRIPTNAME} already exists!"
    [ -x "$(command -v notify-send)" ] && \
        notify-send -t 2000 "" "Another instance of ${SCRIPTNAME} already exists!"
    exit
fi

# Select prompt
case "${WATCHMENU_PROMPT}" in
    rofi)
        prompt="rofi -dmenu -p"
        ;;
    fzf)
        prompt="fzf --bind alt-enter:print-query --prompt"
        ;;
    dmenu | "")
        prompt="dmenu -l 16 -p"
        ;;
    *)
        prompt="${WATCHMENU_PROMPT}"
        echo "Selected custom prompt: ${prompt}"
        ;;
esac

# Select player
case "${VIDEO_PLAYER}" in
    mpv | "")
        video_player="mpv --fs --save-position-on-quit --no-keepaspect-window"
        ;;
    *)
        video_player="${VIDEO_PLAYER}"
        echo "Selected custom video player: ${video_player}"
        ;;
esac

# Get cache location
WATCHMENU_CACHE="${XDG_CACHE_HOME:-${HOME}/.cache}/watchmenu"
[ ! -d "${WATCHMENU_CACHE}" ] && mkdir -vp "${WATCHMENU_CACHE}"

ANIME_DIRS=(  "${HOME}/Media/Anime"    "${HOME}/Shared/Media/Anime"    "${HOME}/Cloud/Media/Anime"    )
TVSHOW_DIRS=( "${HOME}/Media/TV Shows" "${HOME}/Shared/Media/TV Shows" "${HOME}/Cloud/Media/TV Shows" )
MOVIE_DIRS=(  "${HOME}/Media/Movies"   "${HOME}/Shared/Media/Movies"   "${HOME}/Cloud/Media/Movies"   )
VIDEO_DIRS=(  "${HOME}/Videos"         "${HOME}/Downloads"                                            )

# Show help
help () {
    selection="$(cat <<- EOF | ${prompt} " Help page"
		 Cancel
		 Back
		USAGE:
		Search for media you have in your device. You can specify directories in this script itself.
		Once you're done, choose Update on launching this script again.
		To list all entries in your media directories, choose Show All in previous menu.
		COMMANDS:
		:q - Quit
		:s - Go to search screen
		:b - Go back to previous screen
		EOF
    )"

    case "${selection}" in
        :q | " Cancel" | "")
            exit
            ;;
        :s)
            main
            ;;
        :b | " Back")
            main
            ;;
        *)
            main
            ;;
    esac
}

# Update media list
update_list () {
    echo "Category to update: $1"
    case "$1" in
    anime )
        find "${ANIME_DIRS[@]}" -maxdepth 1 -mindepth 1 -type d  2>/dev/null \
            | awk -F '/' '{print $NF}' \
            | sort > "${WATCHMENU_CACHE}/watchmenu-anime-list"
            ;;
    tvshows )
        find "${TVSHOW_DIRS[@]}" -maxdepth 1 -mindepth 1 -type d \
            | awk -F '/' '{print $NF}' \
            | sort > "${WATCHMENU_CACHE}/watchmenu-tvshows-list"
            ;;
    movies )
        find "${MOVIE_DIRS[@]}" -maxdepth 1 -mindepth 1 \
            | awk -F '/' '{print $NF}' \
            | sort > "${WATCHMENU_CACHE}/watchmenu-movies-list"
            ;;
    videos )
        find "${VIDEO_DIRS[@]}" -maxdepth 1 -mindepth 1 -type f \
            -name "*.mp4" -o -name "*.mkv" -o -name "*.avi" \
            -name "*.ogv" -o -name "*.webm" -o -name "*.rmvb" \
            -name "*.flv" -o -name "*.wmv" -o -name "*.mpeg" \
            -name "*.mpg" -o -name "*.m4v" -o -name "*.3gp" \
            | awk -F '/' '{print $NF}' \
            | sort > "${WATCHMENU_CACHE}/watchmenu-videos-list"
        find "${VIDEO_DIRS[@]}" -maxdepth 1 -mindepth 1 -type f \
            -name "*.mp4" -o -name "*.mkv" -o -name "*.avi" \
            -name "*.ogv" -o -name "*.webm" -o -name "*.rmvb" \
            -name "*.flv" -o -name "*.wmv" -o -name "*.mpeg" \
            -name "*.mpg" -o -name "*.m4v" -o -name "*.3gp" \
            | awk -F '/' '{print $NF"<->"$0}' \
            | sort \
            | awk -F '<->' '{print $NF}' > "${WATCHMENU_CACHE}/watchmenu-videos-paths"
            ;;

    esac

    cat "${WATCHMENU_CACHE}/watchmenu-anime-list" \
        "${WATCHMENU_CACHE}/watchmenu-movies-list" \
        "${WATCHMENU_CACHE}/watchmenu-tvshows-list" \
        "${WATCHMENU_CACHE}/watchmenu-videos-list" \
        | sort > ${WATCHMENU_CACHE}/watchmenu-all-list
}

search_youtube_vid () {
    title=" Search YouTube Videos "
    options=$( echo -e " Cancel\n Back\n$(tac "${WATCHMENU_CACHE}/watchmenu-watch-history" | grep "^ " | awk -F '<==>' '{print $1}' | awk '!seen[$0]++' )" )

    query="$(${prompt} "${title}" < <(echo "${options}"))"

    case "${query}" in
      " Cancel")
        exit
        ;;
      " Back")
        main
        ;;
       *)
        var="$(tac "${WATCHMENU_CACHE}/watchmenu-watch-history" | grep "${query}" | sed -n '1p')"
        url="$(echo ${var} | awk -F '<==>' '{print $NF}' )"
        echo "YT URL: ${url}"
        [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
        echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
        
        ${video_player} "${url}"
        search_youtube_vid
        ;;
      '')
        exit
        ;;
      *) # Taken from Bugswriter's myyt script
        query="${query// /+}"
        YT_API_KEY="$( cat "${HOME}"/.api_keys/YT_API_KEY )"
        urlstring="https://www.googleapis.com/youtube/v3/search?part=snippet&q=${query}&type=video&maxResults=20&key=${YT_API_KEY}"

        [ -e "${WATCHMENU_CACHE}/youtube-search-results" ] && \
          rm -rf "${WATCHMENU_CACHE}/youtube-search-results" || \
          touch "${WATCHMENU_CACHE}/youtube-search-results"
        curl -s "${urlstring}" \
          | jq -r '.items[] | "  \(.snippet.channelTitle) - \(.snippet.title)<==>https://www.youtube.com/watch?v=\(.id.videoId)"' \
          | sed 's/&amp;/\&/g' | sed 's/&#38;/\&/g' \
          | sed "s/&apos;/\'/g" | sed "s/&#39;/\'/g" \
          | sed 's/&quot;/\"/g' | sed 's/&#34;/\"/g' >> "${WATCHMENU_CACHE}/youtube-search-results"

        title="$(cat "${WATCHMENU_CACHE}/youtube-search-results" | awk -F '<==>' '{print $1}' | ${prompt} "Select Video" )"
        
        case "${title}" in
          :b) 
            search_youtube_vid
            ;;
          :s)
            main
            ;;
          *)
            if [ ! -z "${title}" ]; then
                grep_pattern="$(echo "${title}" | sed -r 's/\[/\\\[/g' | sed -r 's/\]/\\\]/g' )"

                url="$(cat "${WATCHMENU_CACHE}/youtube-search-results" | grep -i "$grep_pattern" | sed -n '1p' | awk -F '<==>' '{print $NF}')"

                var="${title}<==>${url}"

                [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
                  echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history" 
                
                ${video_player} "${url}"
                
                echo "Title: ${title}"
                echo "URL: ${url}"
            fi
            search_youtube_vid
            ;;
        esac
        
	;;
    esac
}

watch_history () {
    title=" Watch History"
    options="$(echo -e " Cancel\n Back\n Clear Watch History\n$(tac "${WATCHMENU_CACHE}/watchmenu-watch-history" | awk -F '<==>' '{print $1}')")"

    watch_history_sel="$(${prompt} "${title}" < <(echo "${options}"))"
    echo Watch History selection : "${watch_history_sel}"
    grep_pattern="$(echo "${watch_history_sel}" | sed -r 's/\[/\\\[/g' | sed -r 's/\]/\\\]/g' )"
    echo GREP Pattern : "${grep_pattern}"
    file_path="$(cat "${WATCHMENU_CACHE}/watchmenu-watch-history" | grep -i "${grep_pattern}" | sed -n '1p' | awk -F '<==>' '{print $NF}')"
    echo File Path : "${file_path}"

    case "${watch_history_sel}" in
      :q | " Cancel") 
        exit
        ;;
      :s | :b | " Back") 
        main
        ;;
      " Clear Watch History")
        rm -rf "${WATCHMENU_CACHE}/watchmenu-watch-history"
        ;;
      " Videos")
        ${video_player} --playlist="${LAST_PLAYED_PATH}"
        main
        ;;
      *) 
        var="${watch_history_sel}<==>${file_path}"
        [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
        echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
        ${video_player} "${file_path}"
        ;;
    esac
}

# Main menu
main () {
    LAST_PLAYED_NAME="$(tac "${WATCHMENU_CACHE}/watchmenu-watch-history" | awk -F '<==>' '{print $1}'  | sed -n '1p')"
    LAST_PLAYED_PATH="$(tac "${WATCHMENU_CACHE}/watchmenu-watch-history" | awk -F '<==>' '{print $NF}' | sed -n '1p')"

    title=" Search"
    options="$(echo -e " Cancel\n神 Last Played [${LAST_PLAYED_NAME}]\n Search YouTube Videos\n Watch History\n Show All\n Help\n Update\n話 Anime\n TV Shows\n Movies\n Videos" )"

    # Request selection
    main_selection="$(${prompt} "${title}" < <(echo "${options}"))"

    echo "Search Query: ${main_selection}"
    case "${main_selection}" in
        " Search YouTube Videos")
            search_youtube_vid
            ;;
        *youtube*watch?v=*)
            id="$(awk -F '=' '{print $NF}' <<< ${main_selection})"
            title="$(yt-dlp --no-warnings --print "  %(channel)s - %(title)s" "${id}")"
            ${video_player} "${main_selection}"

            var="${title}<==>${main_selection}"
            [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
            echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
            echo "Title: ${title}"
            main
            ;;
        *youtu.be*)
            id="$(awk -F '=' '{print $NF}' <<< ${main_selection})"
            title="$(yt-dlp --no-warnings --print "  %(channel)s - %(title)s" "${id}")"
            ${video_player} "${main_selection}"

            var="${title}<==>${main_selection}"
            [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
            echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
            echo "Title: ${title}"
            main
            ;;
        *youtube*playlist?list=*)
            title="$(yt-dlp --no-warnings -I 1:1,1 --print "   %(playlist_uploader)s - %(playlist_title)s" "${main_selection}")"
            ${video_player} "${main_selection}"

            var="${title}<==>${main_selection}"
            [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
            echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
            echo "Title: ${title}"
            main
            ;;
        http*mp4* | http*webm* | http*mkv* | http*cdn*)
            ${video_player} "${main_selection}"
            
            title="$(echo "${main_selection}" | awk -F '/' '{print $NF}')"
            var="${title}<==>${main_selection}"
            [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
            echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
            main
            ;;
        :q* | " Cancel")
            exit
            ;;
        :h | " Help")
            help
            ;;
        *"神 Last Played"*)
            echo "${LAST_PLAYED_NAME}"
            case "${LAST_PLAYED_NAME}" in
              " Videos")
                  ${video_player} --playlist="${LAST_PLAYED_PATH}"
                  main
                  ;;
              '')
                  notify-send -t 2000 "" "No record of last played items"
                  main
                  ;;
              *) 
                  ${video_player} "${LAST_PLAYED_PATH}"
                  main
                  ;;
            esac
            ;;
        " Watch History")
            watch_history && main
            ;;
        :u | " Update")
            title=" Choose category"
            options="$(printf " Cancel\n Back\n Update All\n話 Anime\n TV Shows\n Movies\n Videos")"

            update_selection="$(${prompt} "${title}" < <(echo "${options}"))"

            case "${update_selection}" in
                :q | " Cancel" | "")
                    exit
                    ;;
                :s)
                    main
                    ;;
                :b | " Back")
                    main
                    ;;
                " Update All")
                    update_list anime
                    update_list tvshows
                    update_list movies
                    update_list videos
                    ;;
                "話 Anime")
                    update_list anime
                    ;;
                " TV Shows")
                    update_list tvshows
                    ;;
                " Movies")
                    update_list movies
                    ;;
                " Videos")
                    update_list videos
                    ;;
            esac
            main
            ;;
        /* | ~*)
            if [[ -e "${main_selection}" ]]; then
              ${video_player} "${main_selection}"
              
              title="$(echo "${main_selection}" | awk -F '/' '{print $NF}')"
              var="${title}<==>${main_selection}"
              [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
              echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
            else
              notify-send -t 2000 " Error" "Could not find what you're looking for\!"
            fi
            main
            ;;
    esac

    search_results
}

# Get the root directory of given file/sub-directory by checking with above specified directories. Brute forcing?
abs_dir () {
    # Find $1 in different arrays of user specified directories. Not using -name flag to avoid problems with special characters.
    # Selecting every line related to $1 with `grep -F` (-F flag to select special characters as well)
    # and picking the first one with sed, since that's the root directory of $1.  
    path="$(find "${VIDEO_DIRS[@]/%//${1}}" "${MOVIE_DIRS[@]/%//${1}}" "${ANIME_DIRS[@]/%//${1}}" "${TVSHOW_DIRS[@]/%//${1}}" -mindepth 0 -maxdepth 1 \
                    | grep -F "$1" \
                    | sed -n '1p')"

    case "${path}" in
        "")
            2>&1 echo "ERROR"
            exit
            ;;
        *)
            show_dir="${path}"
            ;;
    esac

    func_result="${show_dir}"
    echo "${func_result}"
}

search_results () {
    case "${main_selection}" in
        " Show All")
            title="磊 Pick a show/movie"
            options="$(printf " Cancel\n Back\n$(cat "${WATCHMENU_CACHE}/watchmenu-all-list")")"
            ;;
        "話 Anime")
            title="話 Pick a show"
            options="$(printf " Cancel\n Back\n$(cat "${WATCHMENU_CACHE}/watchmenu-anime-list")")"
            ;;
        " TV Shows")
            title=" Pick a show"
            options="$(printf " Cancel\n Back\n$(cat "${WATCHMENU_CACHE}/watchmenu-tvshows-list")")"
            ;;
        " Movies")
            title=" Pick a movie"
            options="$(printf " Cancel\n Back\n$(cat "${WATCHMENU_CACHE}/watchmenu-movies-list")")"
            ;;
        " Videos")
            title=" Pick a video"
            options="$(printf " Cancel\n Back\n Play All\n$(cat "${WATCHMENU_CACHE}/watchmenu-videos-list")")"
            ;;
        "")
            exit
            ;;
        *)
            title="Choose"
            grep_pattern="$(echo "${main_selection}" | sed -r 's/\[/\\\[/g' | sed -r 's/\]/\\\]/g' )"
            options="$(printf " Cancel\n Back\n$(cat "${WATCHMENU_CACHE}/watchmenu-all-list" | grep -i "${grep_pattern}" | sort )")"
            ;;
    esac

    # Request selection
    selection="$(${prompt} "${title}" < <(echo "${options}"))"

    case "${selection}" in
        "" | " Videos")
            exit
            ;;
        " Play All") 
            var=" Videos<==>${WATCHMENU_CACHE}/watchmenu-videos-paths"
            [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
            echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
            ${video_player} --playlist="${WATCHMENU_CACHE}/watchmenu-videos-paths"
            
            search_results
            ;;
        " Cancel")
            exit
            ;;
    esac

    # If chosen option is a video file - get its absolute path and play it
    file_path="$(abs_dir "${selection}")"
    if [ "$(file -bi "${file_path}" | grep -o "video")" == "video" ]; then
        title="$(awk -F '/' '{print  ".../" $(NF-2) "/" $(NF-1) "/" $(NF)}' < <(echo "${file_path}"))"
        var="${title}<==>${file_path}"
        [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
        echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
        ${video_player} "${file_path}"
        
        search_results
    fi

    case "${selection}" in
        :q | " Cancel")
            exit
            ;;
        :s)
            main
            ;;
        :b | " Back")
            main
            ;;
        *)
            show_dir="$(abs_dir "${selection}")"
            echo "Show Dir: ${show_dir}"
            ;;
    esac

    case "${show_dir}" in
        ERROR)
            notify-send -t 2000 " Error" "Could not find the specified show/movie. Check your internet connection or try updating the media list."
            main
            ;;
    esac

    season_list
}

# Choose season directory
season_list () {
    dir1="$(echo "${show_dir}" | awk -F '/' '{print $NF}' )"
    echo "Dir: $dir1"
    dir_type="$(echo "${show_dir}" | sed "s/${dir1}//g" | sed 's/.$//g' )"
    echo "Dir type: $dir_type"

    for VAR in "${MOVIE_DIRS[@]}"
    do
      [[ "${VAR}" == "${dir_type}" ]] && dir_type='MOVIE' && break
    done
    echo "Directory Type: ${dir_type}"

    case "${dir_type}" in
        MOVIE)
            # This will skip to episode_list
            season="NONE"
            season_dir="${show_dir}"
            ;;
        *)
            # Choose season of the show previously chosen
            title="  Choose season"
            options="$(printf " Cancel\n Back\n Play All\n%s" "$(find "${show_dir}" -mindepth 1 -type d 2>/dev/null | sort -V | awk -F '/' '{print $NF}')")"
            selection="$(${prompt} "${title}" < <(echo "${options}"))"

            season="${selection}"
            season_dir="${show_dir}/${season}"
            case "${selection}" in
                :q | " Cancel" | "")
                    exit
                    ;;
            esac
            ;;
    esac

    echo "Season Dir: ${season_dir}"

    case "${season}" in
        " Play All")
            title="$(awk -F '/' '{print  ".../" $(NF-2) "/" $(NF-1) "/" $(NF)}' < <(echo "${show_dir}"))"
            var="${title}<==>${show_dir}"
            [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
            echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
            ${video_player} "${show_dir}"
            
            season_list
            ;;
        :s)
            main
            ;;
        :b | " Back")
            search_results
            ;;
    esac

    episode_list
}

# Choose episode/movie file
episode_list () {
    case "${show_dir}" in
        */Movie*)
            title=" Choose movie"
            options="$(printf " Cancel\n Back\n Play All\n%s" "$(find "${season_dir}" -mindepth 1 -maxdepth 1 -type f 2>/dev/null \
                | awk -F '/' '{print $NF}' \
                | sort -u)")"
            selection="$(${prompt} "${title}" < <(echo "${options}"))"

            movie="${selection}"
            file_path="${season_dir}/${movie}"

            case "${movie}" in
                " Play All")
                    title="$(awk -F '/' '{print  ".../" $(NF-2) "/" $(NF-1) "/" $(NF)}' < <(echo "${season_dir}"))"
                    var="${title}<==>${season_dir}"
                    [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
                    echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
                    ${video_player} "${season_dir}"
                    
                    episode_list
                    ;;
                :s)
                    main
                    ;;
                :b | " Back")
                    search_results
                    ;;
                :q | " Cancel")
                    exit
                    ;;
            esac
            ;;
        *)
            title="  Choose episode"
            options="$(printf " Cancel\n Back\n Play All\n%s" "$(find "${season_dir}" -mindepth 1 -maxdepth 1 -type f 2>/dev/null \
                | awk -F '/' '{print $NF}' \
                | sort -u)")"
            selection="$(${prompt} "${title}" < <(echo "${options}"))"

            episode="${selection}"
            file_path="${season_dir}/${episode}"

            case "${episode}" in
                " Play All")
                    title="$(awk -F '/' '{print  ".../" $(NF-2) "/" $(NF-1) "/" $(NF)}' < <(echo "${season_dir}"))"
                    var="${title}<==>${season_dir}"
                    [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
                    echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"
                    ${video_player} "${season_dir}"
                    
                    episode_list
                    ;;
                :s)
                    main
                    ;;
                :b | " Back")
                    season_list
                    ;;
                :q | " Cancel")
                    exit
                    ;;
            esac
            ;;
    esac

    echo "File path: ${file_path}"
    title="$(awk -F '/' '{print  ".../" $(NF-2) "/" $(NF-1) "/" $(NF)}' < <(echo "${file_path}"))"
    var="${title}<==>${file_path}"
    [[ "${var}" != "$(sed -n '$p' "${WATCHMENU_CACHE}/watchmenu-watch-history")" ]] && \
    echo "${var}" >> "${WATCHMENU_CACHE}/watchmenu-watch-history"

    ${video_player} "${file_path}"
    
    episode_list
}

# Uncomment these lines to automatically update list upon running the script
# update_list anime
# update_list tvshows
# update_list movies
update_list videos

main
